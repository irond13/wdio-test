# WebdriverIO Test Project

WebdriverIO v9 with TypeScript, Mocha, and Allure reporting. Demonstrates dynamic debug logging on retries and hook failure reporting.

## Quick Start

```bash
npm install
npm test
npm run allure:generate  # Requires Java
npm run allure:open
```

## Complete File Reference

### Configuration Files

| File | Purpose |
|------|---------|
| `package.json` | Dependencies and npm scripts |
| `tsconfig.json` | TypeScript compiler config (CommonJS, ES2021) |
| `wdio.conf.ts` | Main WebdriverIO configuration (runs all specs) |
| `wdio.validate.conf.ts` | Validation config (uses allure-validate folder, runs single spec) |
| `.gitignore` | Ignores allure-results/, allure-report/, node_modules/ |

### Test Files (test/specs/)

| File | Purpose |
|------|---------|
| `example.e2e.ts` | Basic test - navigates to example.org, verifies title/heading |
| `retryDemo.e2e.ts` | Demonstrates retry with dynamic debug logging (fails 1st, passes 2nd) |
| `scenario1-allPass.e2e.ts` | All hooks pass (global, spec, suite levels) |
| `scenario2-globalFails.e2e.ts` | Global hook fails, kills all tests |
| `scenario3-specFails.e2e.ts` | Spec-level hook fails |
| `scenario4-suiteFails.e2e.ts` | Suite-level hook fails |
| `failingHook.e2e.ts` | Root hook failure demo |
| `failingHookScreenshots.e2e.ts` | Hook failure with screenshots/steps |
| `failingHookStep.e2e.ts` | Hook failure with explicit Allure steps |
| `failingRootHook.e2e.ts` | Root-level before() hook failure |

### Test Infrastructure (test/support/)

| File | Purpose |
|------|---------|
| `AllureFailingHookReporter.ts` | Custom WDIO reporter that captures evidence from failing beforeAll/afterAll hooks and creates synthetic test entries in Allure |
| `globalSetup.ts` | Mocha root hook plugin providing global beforeAll setup (navigates, takes screenshots) |
| `retryLogger.ts` | Mocha root hook plugin that dynamically switches ALL WDIO loggers to DEBUG level during test retries, then restores original levels |

### Generated Folders

| Folder | Purpose | Source |
|--------|---------|--------|
| `allure-results/` | Raw JSON test results, screenshots, attachments (cleared between runs) | Tests via @wdio/allure-reporter |
| `allure-report/` | Static HTML report with interactive UI | Generated by `allure generate` command |
| `allure-validate/` | Isolated results folder for validation runs | wdio.validate.conf.ts uses this instead of allure-results |

### Documentation (screenshots/)

| File | Purpose |
|------|---------|
| `SCENARIOS-README.md` | Explains test scenario screenshots |
| `CONSOLE-LOGS-EXPLAINED.md` | Details how console logs are captured in Allure |
| `README.md` | Screenshots validation guide |
| `SCENARIOS-*.png` | Visual proof of hook failure reporting working |

## Key Features Explained

### 1. Dynamic Debug Logging on Retries

**Location:** `test/support/retryLogger.ts`

**What it does:**
When a test fails and will be retried, automatically switches ALL WDIO loggers (devtools, webdriver, utils, etc.) to DEBUG level. After test passes or exhausts retries, restores original log levels.

**Why it's needed:**
Retries often fail for different reasons than the first attempt. Debug logs from WebDriver protocol help diagnose race conditions, timing issues, and transient failures.

**How it works:**
1. Saves `process.env.WDIO_LOG_LEVEL` and each logger's individual level
2. On retry: Sets `process.env.WDIO_LOG_LEVEL='debug'` and calls `getLogger.setLogLevelsConfig({}, 'debug')`
3. After retry: Restores env var and manually calls `logger.setLevel()` on each logger

**Preserves configuration:**
- Respects both `config.logLevel` (global default)
- Respects `config.logLevels` (per-logger overrides)
- Handles external `WDIO_LOG_LEVEL` env var (takes precedence over config)

**Implementation details:**
- Uses `mochaGlobalSetup` to initialize logger (ESM-only module in CommonJS project)
- Cannot use top-level await (CommonJS limitation)
- Must use `await import('@wdio/logger')` dynamic import

**Sources:**
- WDIO Logger ESM-only: https://github.com/webdriverio/webdriverio/issues/10520
- Mocha Global Fixtures: https://mochajs.org/next/features/global-fixtures/

### 2. Allure Hook Failure Reporting

**Location:** `test/support/AllureFailingHookReporter.ts`

**What it does:**
Captures screenshots, steps, and console logs from beforeAll/afterAll hooks that fail before any test runs, creates synthetic test entries in Allure to display the evidence.

**Why it's needed:**
WebdriverIO executes hooks before creating test contexts. Without this reporter, evidence from failing hooks (screenshots, Allure steps, console output) disappears because there's no test container to attach them to.

**How it works:**
1. Buffers all `allure:runtimeMessage` events during hook execution
2. Wraps `process.stdout.write` to capture console output
3. When hook fails: Creates synthetic test entry, replays buffered events
4. When hook succeeds: Prepends hook logs to first real test's console output

**What it captures:**
- Allure steps (nested hierarchy preserved)
- Screenshots via browser.takeScreenshot()
- Console logs (via stdout wrapper)
- Error details with stack traces

### 3. Global Mocha Setup

**Location:** `test/support/globalSetup.ts`

**What it does:**
Provides a global beforeAll hook that runs once per worker process before any tests. Navigates to example.org and takes screenshots with Allure steps.

**Purpose:**
Demonstrates Mocha root hook plugin pattern and provides baseline browser state for tests.

## Configuration

### WebdriverIO (wdio.conf.ts)

```typescript
{
  automationProtocol: 'devtools',  // Uses Chrome DevTools (no Selenium)
  logLevel: 'info',                 // Global log level
  // logLevels: {                   // Optional per-logger overrides
  //   'webdriver': 'silent'
  // },

  framework: 'mocha',
  mochaOpts: {
    ui: 'bdd',
    timeout: 60000,
    require: [
      './test/support/globalSetup.ts',    // Global hooks
      './test/support/retryLogger.ts'      // Retry logging
    ],
    retries: 1  // Can override per-test: this.retries(2)
  },

  reporters: [
    'spec',
    [AllureFailingHookReporter, {}],      // Custom reporter
    ['allure', {
      outputDir: 'allure-results',
      addConsoleLogs: true                 // Capture console.log in attachments
    }]
  ]
}
```

### Log Level Priority

When WDIO creates a logger, it checks in this order:
1. `config.logLevels['logger-name']` (per-logger override)
2. `process.env.WDIO_LOG_LEVEL` (external env var or set from config.logLevel)
3. DEFAULT_LEVEL ('info')

**Priority chain:** External WDIO_LOG_LEVEL env var > config.logLevels > config.logLevel

## Test Scenarios

The scenario tests demonstrate hook execution at different levels:

| Scenario | Global Hook | Spec Hook | Suite Hook | Result |
|----------|-------------|-----------|------------|--------|
| scenario1-allPass | Pass | Pass | Pass | Test runs |
| scenario2-globalFails | Fail | - | - | All tests killed |
| scenario3-specFails | Pass | Fail | - | Spec killed |
| scenario4-suiteFails | Pass | Pass | Fail | Suite killed |

## NPM Scripts

```bash
npm test                  # Run all tests (wdio.conf.ts)
npm run wdio              # Same as npm test
npm run allure:generate   # Generate HTML report from results
npm run allure:open       # Open report in browser
npm run allure:serve      # Generate and serve in one command
```

## Allure Workflow

1. **Run tests** → Creates `allure-results/` (JSON files, screenshots, attachments)
2. **Generate report** → Creates `allure-report/` (static HTML/JS/CSS)
3. **View report** → Opens `allure-report/index.html` in browser

**Note:** Both allure-results/ and allure-report/ are gitignored (regenerated on each run).

## Technical Notes

### Why Dynamic Import for @wdio/logger

The `@wdio/logger` package is ESM-only since v8+. In CommonJS TypeScript projects:
- Static imports fail: "require() of ES Module not supported"
- Top-level await not supported: "Top-level await is currently not supported with the 'cjs' output format"
- Solution: Use `await import('@wdio/logger')` inside async function (mochaGlobalSetup)

### Why mochaGlobalSetup

Runs once per worker process (not once per test suite). Perfect for initializing shared resources like loggers that all tests in the worker need.

Source: https://mochajs.org/next/features/global-fixtures/

## References

- WebdriverIO: https://webdriver.io/
- Mocha: https://mochajs.org/
- Allure: https://allurereport.org/
- @wdio/logger ESM issue: https://github.com/webdriverio/webdriverio/issues/10520
